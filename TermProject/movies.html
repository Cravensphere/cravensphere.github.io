<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Search</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/3.2.1/mustache.min.js"></script>
</head>
<body>
    <header>
        <h1>Movie Search</h1>
    </header>
    <main>
        <div class="search-container">
            <input type="text" id="search-query" placeholder="Enter movie title or director">
            <button id="search-button">Search</button>
            <button id="toggle-layout">Toggle Layout</button>
        </div>
        <div id="results" class="grid-container"></div>
        <div id="pagination"></div>
        <div id="movie-details"></div>
        <h2>Popular Movies and TV Shows</h2>
        <div id="collection" class="grid-container"></div>
    </main>
    <script>
        $(document).ready(function() {
            var startIndex = 1;
            var maxResults = 10;
            var totalResults = 0;
            var currentPage = 1;
            var isGridLayout = true;
            var currentResults = [];

            function fetchMovies(query, page) {
                $.ajax({
                    url: `https://api.themoviedb.org/3/search/movie?api_key=56e665fbc9c321fad4cfb7957c12244b&query=${query}&page=${page}`,
                    method: 'GET',
                    success: function(data) {
                        totalResults = data.total_results;
                        currentResults = data.results;
                        renderResults();
                    },
                    error: function(error) {
                        console.error('Error fetching movies:', error);
                    }
                });
            }

            function fetchPopularMoviesAndShows() {
                $.ajax({
                    url: `https://api.themoviedb.org/3/trending/all/week?api_key=56e665fbc9c321fad4cfb7957c12244b`,
                    method: 'GET',
                    success: function(data) {
                        renderCollection(data.results);
                    },
                    error: function(error) {
                        console.error('Error fetching popular movies and shows:', error);
                    }
                });
            }

            function renderResults() {
                var template = $('#movie-template').html();
                var rendered = Mustache.render(template, { movies: currentResults });
                $('#results').html(rendered);
                $('.movie-title').click(function() {
                    var movieId = $(this).data('id');
                    fetchMovieDetails(movieId);
                });
            }

            function renderCollection(items) {
                var template = $('#collection-template').html();
                var rendered = Mustache.render(template, { items: items });
                $('#collection').html(rendered);
                $('.item-title').click(function() {
                    var itemId = $(this).data('id');
                    fetchMovieDetails(itemId);
                });
            }

            function fetchMovieDetails(movieId) {
                $.ajax({
                    url: `https://api.themoviedb.org/3/movie/${movieId}?api_key=56e665fbc9c321fad4cfb7957c12244b`,
                    method: 'GET',
                    success: function(movieData) {
                        fetchMovieCredits(movieId, movieData);
                    },
                    error: function(error) {
                        console.error('Error fetching movie details:', error);
                    }
                });
            }

            function fetchMovieCredits(movieId, movieData) {
                $.ajax({
                    url: `https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=56e665fbc9c321fad4cfb7957c12244b`,
                    method: 'GET',
                    success: function(creditsData) {
                        renderMovieDetails(movieData, creditsData.cast);
                    },
                    error: function(error) {
                        console.error('Error fetching movie credits:', error);
                    }
                });
            }

            function renderMovieDetails(movie, cast) {
                var detailsHtml = `
                    <h2>${movie.title}</h2>
                    <img src="https://image.tmdb.org/t/p/w200${movie.poster_path}" alt="${movie.title} poster">
                    <p><strong>Release Date:</strong> ${movie.release_date}</p>
                    <p><strong>Overview:</strong> ${movie.overview}</p>
                    <p><strong>Genres:</strong> ${movie.genres.map(genre => genre.name).join(', ')}</p>
                    <p><strong>Rating:</strong> ${movie.vote_average}</p>
                    <p><strong>Actors:</strong> ${cast.slice(0, 5).map(actor => actor.name).join(', ')}</p>
                `;
                $('#movie-details').html(detailsHtml);
            }

            $('#search-button').click(function() {
                var query = $('#search-query').val();
                fetchMovies(query, currentPage);
            });

            $('#search-query').keypress(function(event) {
                if (event.which === 13) {
                    var query = $('#search-query').val();
                    fetchMovies(query, currentPage);
                }
            });

            $('#toggle-layout').click(function() {
                isGridLayout = !isGridLayout;
                $('#results').toggleClass('grid-container list-container');
            });

            // Fetch popular movies and shows on page load
            fetchPopularMoviesAndShows();
        });
    </script>
    <script id="movie-template" type="x-tmpl-mustache">
        {{#movies}}
        <div class="movie">
            <img src="https://image.tmdb.org/t/p/w200{{poster_path}}" alt="{{title}} poster">
            <h3><a href="#" class="movie-title" data-id="{{id}}">{{title}}</a></h3>
            <p>{{release_date}}</p>
            <p>{{overview}}</p>
        </div>
        {{/movies}}
    </script>
    <script id="collection-template" type="x-tmpl-mustache">
        {{#items}}
        <div class="item">
            <img src="https://image.tmdb.org/t/p/w200{{poster_path}}" alt="{{title}} poster">
            <h3><a href="#" class="item-title" data-id="{{id}}">{{title}}</a></h3>
            <p>{{release_date}}</p>
        </div>
        {{/items}}
    </script>
</body>
</html>